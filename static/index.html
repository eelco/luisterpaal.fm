<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>3VOOR12 Luisterpaal + Last.fm</title>
    <script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.min.js"></script>
    <script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/swfobject/2.1/swfobject.js"></script>
    <script type="text/javascript">
    var lp;    // Luisterpaal object
    var sk;    // Session key
    var np;    // 'Now Playing' url
    var su;    // Submission url
    var track; // Currently playing track

    // TODO Add a div with status messages.

    $(function() {
        // TODO When implementad in server, check for cookie first
        var token = getCallbackToken();

        if (token == undefined) {
            // TODO Explain to user how this will work before redirecting.
            $.get("key", {}, getNewToken)
            return;
        } // else

        // TODO Get a new token when the handshake fails
        getHandshake(token, onHandshake);
    });

    function onHandshake(handshake) {
        if (handshake.error != undefined) {
            alert("Ah bummer, something went wrong. (" + handshake.error + ")");
            return;
        } // else

        [sk,np,su] = handshake.handshake;
        np = np.replace('http://', '');
        su = su.replace('http://', '');


        swfobject.embedSWF("http://download.omroep.nl/vpro/luisterpaal/"+
                           "widgets/LuisterpaalEvents.swf?oninit=onLPLoad",
                           "luisterpaal","240","320","8", false, 
                           {}, {allowscriptaccess: "always"}, {});
    }

    function getCallbackToken() {
        var match = window.location.search.match(/\?token=([^&]+)/)
        if (match) return match[1]
    }

    function getNewToken(key) {
        window.location.href = 'http://www.last.fm/api/auth?api_key=' + key;
    }

    function getHandshake(token, callback) {
        return $.getJSON("handshake/?token=" + token, callback)
    }

    function onLPLoad() {
       lp = (typeof window["luisterpaal"] != "undefined")
          ? window["luisterpaal"] 
          : document["luisterpaal"];

       // Listen to all events
       lp.addLPEventListener("START",  "start");
       lp.addLPEventListener("STOP",   "stop");
       lp.addLPEventListener("PAUSE",  "pause");
       lp.addLPEventListener("RESUME", "resume");
    }

    function start(e) {
        // A start is an implicit stop of the previous track
        stop();

        var t = e.track;

        track = { a: unescape(t.artist)
                , t: unescape(t.name)
                , b: unescape(t.album)
                , l: t.duration
                , n: t.trackNumber
                , i: now()
                , paused: 0
                , paused_since: undefined
                }

        // TODO Check response
        $.post("proxy/" + np
              , { s: sk
                , a: track.a
                , t: track.t
                , b: track.b
                , l: track.l
                , n: track.n
                , m: ""
                }
              );
    }

    function stop() {
        if (! track) return;
        // else
        
        // Don't scrobble tracks that are too short
        if (track.l < 30) return;
        // else

        // Check if the track was paused
        resume();

        var played_for = now() - track.i - track.paused;
        // Played too short
        if (played_for < 240 && played_for < track.l / 2) return;
        // else

        // TODO Check response
        $.post("proxy/" + su
              , { s: sk
                , a: track.a
                , t: track.t
                , i: track.i
                , o: "P"
                , r: ""
                , b: track.b
                , l: track.l
                , n: track.n
                , m: ""
                }
              );
    }

    function pause() {
        if (! track) return;
        // else
        track.paused_since = now();
    }

    function resume() {
        if (! track || ! track.paused_since) return;
        // else
        track.paused += now() - track.paused_since;
        track.paused_since = undefined;
    }

    function now() {
        return Math.round((new Date()).valueOf() / 1000);
    }

    </script>
  </head>
  <body>
    <div id="luisterpaal">Loading... (if this message doesn't go away, you might have JavaScript disabled)</div>
  </body>
</html>
